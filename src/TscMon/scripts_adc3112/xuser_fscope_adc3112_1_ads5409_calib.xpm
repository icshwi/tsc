#*****************************************************************#
#                    XprsMon Script file                          #
#                XUSER FASTSCOPE (2x ADC_3112)                    #
#   Title        : xuser_fscope_adc3112_1_ads5409_calib.xpm       #
#   Description  : ADS5409 initialisation                         #
#   Author       : J. Bovier / J-L Bolli                          #
#*****************************************************************#
# Version 0.1 16-01-2015 : Initial version ifC_1410/1211          #
#*****************************************************************#

# Check if FMC1 ADC_3112 is present + Signature OK
cr.ws 1200 31120201 FFFFFFFF                     # Check ADC_3112 SIGN_CSR (Type, Version, Revision)                                  
#
#
pr.ws 1200 31120000                             # Enable FMC physical interface (out of tri-state)
#
# ------------------------------------------------------
# Board RESET pulse
# ------------------------------------------------------
pr.ws 1204 00000100
$usleep 2000
pr.ws 1204 00000000
#
# ------------------------------------------------------
# Initialize the XRA1404 GPIO Expander
# ------------------------------------------------------
@xuser_fscope_adc3112_1_xra1404_init.xpm
# ------------------------------------------------------
# Initialize the LMK4803 clock synthetizer
# ------------------------------------------------------
@xuser_fscope_adc3112_1_lmkinit_intref.xpm
# ------------------------------------------------------
# Initialize the ADC5409 devices
# ------------------------------------------------------
@xuser_fscope_adc3112_1_ads5409_init.xpm
# ------------------------------------------------------
# ISERDES ADS5409 Initialisation  
# ------------------------------------------------------
adc3112.1 xratrig write 2 60                # XRA1404 OCR    ADC_ENABLE = 1Z  -> ADS5409 ENABLED
$usleep 2000

pr.ws 1204 00004000
cr.ws 1204 00000000 00008000                 # Check MMCM is un-locked (MCMM RESET)    
pr.ws 1204 00000000
$usleep 2000 
cr.ws 1204 00008000 00008000                 # Check MMCM is locked on ADS5409 channel_0
#
pr.ws 1204 000040c0                          # RESET ISERDES ADS5409
$usleep 1000
pr.ws 1204 00000000                          # Enable  ISERDES ADS5409
$usleep 2000
#
# ------------------------------------------------------
# Initialize Front-end INPUT
# ------------------------------------------------------
adc3112.1 xra01 write 2 55                   # XRA1404 OCR    Grounded ADC inputs
adc3112.1 xra23 write 2 55                   # XRA1404 OCR    Grounded ADC inputs    
# -----------------------------------------------------------------
# Execute ADS5409ISERDES IODELAY Calibration adjustement operation
# Info : Not required if operate > 500 MHz
# -----------------------------------------------------------------
#adc3112.1 ads0123 calib reset verbose       # ADS5409 Calibration Mode with default value   (Set default delay)
#adc3112.1 ads0123 calib verbose             # ADS5409 Calibration Mode with calculated value (Adjust to calculated mean)
#adc3112.1 ads0123 calib reset                # ADS5409 Calibration Mode with default value   (Set default delay)
adc3112.1 ads0123 calib                      # ADS5409 Calibration Mode with calculated value (Adjust to calculated mean)
#
$echo     ADS5409_01 DAQ calibration done
#
adc3112.1 ads01 temp
adc3112.1 ads23 temp
#
$usleep 2000
#
$echo *****************************************************************
$echo     FASTSCOPE ADS5409 ISERDES calibration terminated
$echo *****************************************************************

