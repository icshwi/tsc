#*****************************************************************#
#                    XprsMon Script file                          #
#                XUSER FASTSCOPE (2x ADC_3112)                    #
#   Title        : xuser_fscope_adc3112_1_ads5409_init.xpm        #
#   Description  : ADS5409 initialisation                         #
#   Author       : J. Bovier / J-L Bolli                          #
#*****************************************************************#
# Version 0.1 16-01-2015 : Initial version ifC_1410/1211          #
#*****************************************************************#

# Check if FMC1 ADC_3112 is present + Signature OK
cr.ws 1200 31120201 FFFFFFFF                     # Check ADC_3112 SIGN_CSR (Type, Version, Revision)
#
cr.ws 1204 20000000 FF000000                     # Check ADC_3112 MAIN_CSR (options instantiated)
#
pr.ws 1200 31120000                             # Enable FMC physical interface (out of tri-state)
#
pi.ws 000C C0000000                             # Turn ON FMC Slots !
$usleep 50000
#
#---------------------------------------------------------------------------
#   WARNING : ADS5409 SPI Bus is by default with 3-wire SPI mode
#              --> shall be forced to operate with 4-wire SPI interface
#---------------------------------------------------------------------------
pr.ws 1204 0                                     # Remove ADC RESET (SPI interface RESET)
pr.ws 1204 100                                   # Activate ADC RESET (SPI interface RESET)
pr.ws 1204 0                                     # Remove ADC RESET (SPI interface RESET)
$echo *****************************************************************
$echo ADS5409 Channel 01 U737                                     
$echo *****************************************************************
adc3112.1 xratrig write 2 60                     # XRA1404 OCR    ADC_ENABLE = 1  -> ADS5409 ENABLE = '1'
$usleep 20000
#
adc3112.1 ads01 write 2c D2F0                    # ADS5409_R2c 4 SW RESET  !!!NEW JB20140626
$usleep 4000                    
adc3112.1 ads01 write 0 8000                     # ADS5409_R00 4 Wire SPI + no filter
# Initialization sequence according to data-sheet
adc3112.1 ads01 write 1 8206                     # ADS5409_R01 CHA&B Corr EN + 2's complement + SYNCOUT enable + HP Mode 1
adc3112.1 ads01 write 3 4B18                     # ADS5409_R03 Clear CHA accumulator
adc3112.1 ads01 write 1A 4B18                    # ADS5409_R1A Clear CHB accumulator
$usleep 10000
adc3112.1 ads01 write 3 0B18                     # ADS5409_R03 Start DC and gain auto correction loop
adc3112.1 ads01 write 1A 0B18                    # ADS5409_R1A Start DC and gain auto correction loop
#
adc3112.1 ads01 write 38 FFFF                    # ADS5409_R38 Bias EN + SYNC EN + Input buf EN
adc3112.1 ads01 write 2 0780                     # ADS5409_R02 Over-range threshold = 0
adc3112.1 ads01 write E AAA8                     # ADS5409_R0E Sync from SYNC pins
adc3112.1 ads01 write F A000                     # ADS5409_R0F Sync from SYNC pins + VREF = 1.0 V
adc3112.1 ads01 write 37 d400                    # ADS5409_R37 Light Sleep mode
#adc3112.1 ads01 write 3A fc18                   # ADS5409_R3A LDVS = 3.5 mA + term 100 Ohm + EN DACLK & DBCLK
adc3112.1 ads01 write 3A 4a18                    # ADS5409_R3A LDVS = 2.5 mA + term 200 Ohm + EN DACLK & DBCLK
adc3112.1 ads01 write 66 0FFF                    # ADS5409_R66 LDVS OUTA bus EN
adc3112.1 ads01 write 67 0FFF                    # ADS5409_R67 LDVS OUTB bus EN
#             
$echo *****************************************************************
$echo ADS5409 Channel 23 U740                                     
$echo *****************************************************************
adc3112.1 ads23 write 2c D2F0                    # ADS5409_R2c 4 SW RESET   !!!NEW JB20140626
$usleep 2000                    
adc3112.1 ads23 write 0 8000                     # ADS5409_R00 4 Wire SPI + no filter
# Initialization sequence according to data-sheet
adc3112.1 ads23 write 1 8206                     # ADS5409_R01 CHA&B Corr DIS + 2's complement + SYNCOUT enable + HP Mode 1
adc3112.1 ads23 write 3 4B18                     # ADS5409_R03 Clear CHA accumulator
adc3112.1 ads23 write 1A 4B18                    # ADS5409_R1A Clear CHB accumulator
$usleep 10000
adc3112.1 ads23 write 3 0B18                     # ADS5409_R03 Start DC and gain auto correction loop
adc3112.1 ads23 write 1A 0B18                    # ADS5409_R1A Start DC and gain auto correction loop
#
adc3112.1 ads23 write 38 FFFF                    # ADS5409_R38 Bias EN + SYNC EN + Input buf EN
adc3112.1 ads23 write 2 0780                     # ADS5409_R02 Over-range threshold = F
adc3112.1 ads23 write E AAA8                     # ADS5409_R0E Sync from SYNC pins
adc3112.1 ads23 write F A000                     # ADS5409_R0F Sync from SYNC pins + VREF = 1.0 V
adc3112.1 ads23 write 37 d400                    # ADS5409_R37 Light Sleep mode
#adc3112.1 ads23 write 3A fc18                   # ADS5409_R3A LDVS = 3.5 mA + term 100 Ohm + EN DACLK & DBCLK
adc3112.1 ads23 write 3A 4a18                    # ADS5409_R3A LDVS = 2.5 mA + term 200 Ohm + EN DACLK & DBCLK
adc3112.1 ads23 write 66 0FFF                    # ADS5409_R66 LDVS OUTA bus EN
adc3112.1 ads23 write 67 0FFF                    # ADS5409_R67 LDVS OUTB bus EN
#
$echo *****************************************************************
$echo      ADS5409 temperature                                     
$echo *****************************************************************
adc3112.1 ads01 temp
adc3112.1 ads23 temp
#
$usleep 2000
#
adc3112.1 tmp102 show
$echo *****************************************************************
$echo      ADS5409 01 & 23 initialized
$echo *****************************************************************
# <EOF>
