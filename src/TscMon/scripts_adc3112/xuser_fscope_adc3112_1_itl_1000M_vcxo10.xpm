#*****************************************************************#
#                    XprsMon Script file                          #
#                XUSER FASTSCOPE (2x ADC_3112)                    #
#   Title : xuser_fscope_adc3112_2_all_1000M_VCXO10.xpm           #
#   Description  : ADS5409 data acquisition 1000Msps              #
#   Author       : J. Bovier / J-L Bolli                          #
#*****************************************************************#
# Version 0.1 16-01-2015 : Initial version ifC_1410/1211          #
#*****************************************************************#
# Check if FMC2 ADC_3112 is present + Signature OK
cr.ws 1200 31120201 FFFFFFFF                     # Check ADC_3112 SIGN_CSR (Type, Version, Revision)                                  
cr.ws 1204 20000000 FF000000                     # Check ADC_3112 MAIN_CSR (options instantiated)
#
pr.ws 1200 31120000                             # Enable FMC physical interface (out of tri-state)
# ------------------------------------------------------
# Board RESET pulse
# ------------------------------------------------------
pr.ws 1204 00000100
$usleep 2000
pr.ws 1204 00000000
adc3112.1 ads01 write 0 8000                     # ADS5409_R00 4 Wire SPI + no filter
adc3112.1 ads23 write 0 8000                     # ADS5409_R00 4 Wire SPI + no filter
# ------------------------------------------------------
# Initialize the LMK4803 clock synthetizer
# ------------------------------------------------------
@xuser_fscope_adc3112_1_lmkinit_ext10M_1000M_vcxo.xpm               
$usleep 2000
# ------------------------------------------------------
# Initialize the ADC5409 devices
# ------------------------------------------------------
@xuser_fscope_adc3112_1_ads5409_init.xpm
$usleep 2000
# 
# ------------------------------------------------------
# Initialize the on-board ADS5409 ISERDES
# ------------------------------------------------------
adc3112.1 xratrig write 2 60                 # XRA1404 OCR ITL_ENABLE = 1 -> ADC Enabled  
$usleep 2000
pr.ws 1204 00004000
cr.ws 1204 00000000 00008000                 # Check MMCM is un-locked (MCMM RESET)    
pr.ws 1204 00000000
$usleep 2000 
cr.ws 1204 00008000 00008000                 # Check MMCM is locked on ADS5409 channel_0
pr.ws 1204 000040c0                          # RESET ISERDES ADS5409
pr.ws 1204 00000000                          # RESET ISERDES ADS5409
$usleep 2000
pr.ws 1220 00004000                          # Set default HW digital correction Channel_0
pr.ws 1224 00004000                          #                                   Channel_1
pr.ws 1228 00004000                          #                                   Channel_2
pr.ws 122c 00004000                          #                                   Channel_3
#                             
# ------------------------------------------------------
# Calibration ADS5409 ISERDES
# ------------------------------------------------------
adc3112.1 ads0123 calib                      # ADS5409 Calibration Mode with calculated value (Adjust to calculated mean)
$usleep 2000
#
# ------------------------------------------------------------------------------------
# Initialize Front-end INPUT
# ------------------------------------------------------------------------------------
#adc3112.1 xra01 write 2 55                   # XRA1404 OCR    Grounded ADC inputs
#adc3112.1 xra23 write 2 55                   # XRA1404 OCR    Grounded ADC inputs    
#adc3112.1 xra01 write 2 22                   # XRA1404 OCR    SE Pos input   
#adc3112.1 xra23 write 2 22                   # XRA1404 OCR    SE Pos input   
#adc3112.1 xra01 write 2 EE                   # XRA1404 OCR    SE Neg input   
#adc3112.1 xra23 write 2 EE                   # XRA1404 OCR    SE Neg input  
# ------------------------------------------------------------------------------------ 
adc3112.1 xra01 write 2 22                   
adc3112.1 xra23 write 2 22                   
#                             
# ------------------------------------------------------
# Patch ADC5409 SYNC_OUT work around
# ------------------------------------------------------
adc3112.1 lmk write b 07610000                   # LMK04803B_R11 Device MODE=0x0 + SYNC Enable  + NO_SYNC_CLKoutX_Y = 110110  SYNC_EN_AUTO = 0   clk_OUT0/clk_OUT6 forced '0'   q
#adc3112.1 lmk write b 37610000                   # LMK04803B_R11 Device MODE=0x6 + SYNC Enable  + NO_SYNC_CLKoutX_Y = 110110  SYNC_EN_AUTO = 0   clk_OUT0/clk_OUT6 forced '0'   q
$usleep 2000
adc3112.1 lmk write 0 00140800                   # LMK04803B_R00 Enable  ClkOut_01   + ClkOUT01_DIV = 128 ADS5409 23 SYNC  / TRIG_Calibration     31.500 MHz
adc3112.1 lmk write 1 00140040                   # LMK04803B_R01 Enable  ClkOut_23   + ClkOUT23_DIV = 4   FMC_CLK0_M2C     / ADS5409 01 CLKIN_DEL 1000 MHz
adc3112.1 lmk write 2 00140040                   # LMK04803B_R02 Enable  ClkOut_45   + ClkOUT45_DIV = 4   FMC_LA_32        / ADS5409 23 CLKIN_DEL 1000 MHz 
adc3112.1 lmk write 3 00180800                   # LMK04803B_R03 Enable  ClkOut_67   + ClkOUT67_DIV = 128 ADS5409 01 SYNC  / Not used             31.500 MHz
adc3112.1 lmk write 4 00140040                   # LMK04803B_R04 Enable  ClkOut_89   + ClkOUT89_DIV = 4   ADS5409 01 CLKIN / Not used             1000 MHz
adc3112.1 lmk write 5 00180040                   # LMK04803B_R05 Enable  ClkOut_1011 + ClkOUT1011_DIV = 4 Not used         / ADS5409 23 CLKIN     1000 MHz
$usleep 2000
adc3112.1 ads01 write 1 0003                     # ADS5409_R01 CHA&B Corr EN + 2's complement + SYNCOUT disable + HP Mode 1
adc3112.1 ads23 write 1 0003                     # ADS5409_R01 CHA&B Corr EN + 2's complement + SYNCOUT disable + HP Mode 1
$usleep 2000
adc3112.1 ads23 write 1 0007                     # ADS5409_R01 CHA&B Corr EN + 2's complement + SYNCOUT enable + HP Mode 1   
adc3112.1 ads01 write 1 0007                     # ADS5409_R01 CHA&B Corr EN + 2's complement + SYNCOUT enable + HP Mode 1
#
adc3112.1 lmk write b 07600000                   # LMK04803B_R11 Device MODE=0x0 + SYNC Enable  + NO_SYNC_CLKoutX_Y = 110110  SYNC_EN_AUTO = 0   clk_OUT0/clk_OUT6 running      
#adc3112.1 lmk write b 37600000                   # LMK04803B_R11 Device MODE=0x6 + SYNC Enable  + NO_SYNC_CLKoutX_Y = 110110  SYNC_EN_AUTO = 0   clk_OUT0/clk_OUT6 running      
$usleep 10000
#
#
$echo *************************************************************************************************
$echo **  ADC_3112 Data acquisition Interleaved mode Channel_0       **
$echo *****************************************************************
$echo **  Generator Agilent N51711B 25 MHz/8dBm + Splitter 2.1       **
$echo **  SIN 25_MHz shall be available at IN_1 POS (Channel_02)     **
$echo *****************************************************************
$usleep 2000
wait 100
#
pr.ws 1220 4000                                  # Reset ADC3112 digital correction parameter
pr.ws 1228 4000                                  # Reset ADC3112 digital correction parameter
#
adc3112.1 xratrig write 2 e0                     # XRA1404 OCR ITL_ENABLE = 1  -> ADC Enabled  
adc3112.1 xra01 write 2 22                       # ADC Input 10 Conditionner mode  POS - POS              
adc3112.1 xra23 write 2 22                       # ADC Input 23 Conditionner mode  POS - POS              
#
adc3112.1 ads1 itl enable
adc3112.1 ads1 itl calib                         # Call calibration for GAIN and OFFSET
#
dr.ws 1220..1330                                 # Reset ADC3112 digital correction parameter
# 
fu1.w 100000..13ffff 0                           # FASTSCOPE fill the SRAM buffer with 0x0000,0000 
# Data acquisition with Manual Trigger
pr.ws 11c0 80040001                              # FASTSCOPE ABORT/stop previous acquisition SRAM1 (in case of..))
pr.ws 11c4 0                                     # FASTSCOPE DEFINE trigger mode = Manual
pr.ws 11c0 40040001                              # FASTSCOPE ARM data acquisition SRAM1
$usleep 2000                                     # FASTSCOPE WAIT for 2 ms
pr.ws 11c8 40000000                              # FASTSCOPE TRIGGER  command
$echo   --- ADS5409 Channel (02) data acquisition started
$usleep 2000                    
cr.ws 11c0 30040001 30000000                     # FASTSCOPE CHECK end of acquisition
#
#$echo     FASTSCOPE Buffer data print-out for debugging
du1.hs 102000..102100                            # Channel_0 A  
du1.hs 122000..122100                            # Channel_0 B
#  
#$echo *****************************************************************
$echo     FASTSCOPE Interleaved Buffer SAVE to files
#$echo *****************************************************************
adc3112.1 ads01 save0 d:datatst/adc3112_1000M_0A_ITL_acq_data            # Save acquisition DPRAM_Buffer_0 -> file.cvs
adc3112.1 ads01 save2 d:datatst/adc3112_1000M_0B_ITL_acq_data            # Save acquisition DPRAM_Buffer_2 -> file.cvs
adc3112.1 ads1 itl buf d:datatst/adc3112_1000M_0AB_ITL_acq_data          # Save acquisition DPRAM_Buffer_0+2 realligned -> file.cvs
#
#
adc3112.1 ads01 temp
adc3112.1 ads23 temp
adc3112.1 xratrig write 2 20                    # XRA1404 OCR    ADC_ENABLE = 0  -> ADS5409 disabled
$echo *****************************************************************
$echo     FASTSCOPE basic data acquisition terminated
$echo *****************************************************************


