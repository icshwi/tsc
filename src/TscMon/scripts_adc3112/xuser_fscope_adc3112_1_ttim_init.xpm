#*****************************************************************#
#                    XprsMon Script file                          #
#                XUSER FASTSCOPE (2x ADC_3112)                    #
#   Title        : xuser_fscope_adc3112_2_ttim_init.xpm           #
#   Description  :                                                #
#   Author       : J. Bovier                                      #
#*****************************************************************#
# Version 0.1 16-01-2015 : Initial version ifC_1410/1211          #
#*****************************************************************#
#
# Check if FMC2 ADC_3112 is present + Signature OK
cr.ws 1200 31120201 FFFFFFFF                     # Check ADC_3112 SIGN_CSR (Type, Version, Revision)
#
pr.ws 1200 31120000                          # Enable FMC physical interface (out of tri-state)
#
pi.ws 000C C0000000                             # Turn ON FMC Slots !
$usleep 50000
#
# ------------------------------------------------------
# Board RESET pulse
# ------------------------------------------------------
pr.ws 1204 00000100
$usleep 2000
pr.ws 1204 00000000
#
# ------------------------------------------------------
# Initialize the XRA1404 GPIO Expander
# ------------------------------------------------------
@xuser_fscope_adc3112_1_xra1404_init.xpm
# ------------------------------------------------------
# Initialize the LMK4803 clock synthetizer
# ------------------------------------------------------
@xuser_fscope_adc3112_1_lmkinit_intref.xpm
# ------------------------------------------------------
# Initialize the ADC5409 devices
# ------------------------------------------------------
@xuser_fscope_adc3112_1_ads5409_init.xpm
# ------------------------------------------------------
# ISERDES ADS5409 Initialisation  
# ------------------------------------------------------
adc3112.1 xratrig write 2 40                 # XRA1404 OCR    ADC_ENABLE = 1  -> ADS5409 ENABLE = '1'
$usleep 2000
pr.ws 1204 00004000
cr.ws 1204 00000000 00008000                 # Check MMCM is un-locked (MCMM RESET)    
pr.ws 1204 00000000
$usleep 2000 
cr.ws 1204 00008000 00008000                 # Check MMCM is locked on ADS5409 channel_0
#
pr.ws 1204 000040c0                          # RESET ISERDES ADS5409
$usleep 1000
pr.ws 1204 00000000                          # Enable  ISERDES ADS5409
$usleep 2000
#
# ------------------------------------------------------
# ISERDES TTIM Initialisation 
# ------------------------------------------------------
pr.ws 1230 50F00000                          # IODELAY default prog value TTIM data
#
pr.ws 1230 10000000                          # IODELAY Read-out pointer
cr.ws 1230 00000400 00000F00                 # IODELAY TAP value verification
pr.ws 1230 10100000                          # IODELAY Read-out pointer
cr.ws 1230 00000700 00000F00                 # IODELAY TAP value verification
pr.ws 1230 10200000                          # IODELAY Read-out pointer
cr.ws 1230 00000A00 00000F00                 # IODELAY TAP value verification
pr.ws 1230 10300000                          # IODELAY Read-out pointer
cr.ws 1230 00000D00 00000F00
#
# ------------------------------------------------------
# Enable TTIM Initialisation 
# ------------------------------------------------------
adc3112.1 lmk write 6 011102e0                # LMK04803B_R06 ClkOUT3_Type=0 / ClkOUT2_Type=1 / ClkOUT1_Type=1/ ClkOUT0_Type=1 (0=Power down; 1=LVDS) 
adc3112.1 lmk write 7 01010000                # LMK04803B_R07 ClkOUT7_Type=0 / ClkOUT6_Type=1 / ClkOUT5_Type=1/ ClkOUT4_Type=1 (0=Power down; 1=LVDS) 
adc3112.1 lmk write 8 10010000                # LMK04803B_R08 ClkOUT11_Type=0/ ClkOUT10_Type=0/ ClkOUT9_Type=0/ ClkOUT8_Type=0 (0=Power down; 1=LVDS) 
# ... signal TRIGCAL = 1/16 F_native
adc3112.1 xratrig write 6 00                  # XRA1404 GSR Initialisation -> All outputs
adc3112.1 xratrig write 8 FF                  # XRA1404 PUR Initialisation -> Pull-up 3.3V
adc3112.1 xratrig write c 87                  # XRA1404 TCSR Initialisation ->  x-543xxx totem-pole / 7-xxx210 tri-state
adc3112.1 xratrig write 2 18                  # XRA1404 OCR    TrigSEL[5:3] = 011  -> Select Trigger calibration  
#
# ------------------------------------------------------
# Control TTIM Logic 
# ------------------------------------------------------
$echo    Enable TTIM driver  U749 SY89832 
pr.ws 1234 00000080                          # Enable TTIM driver  U749 SY89832
pr.ws 1234 00000082                          # Trigger clear
pr.ws 1234 00000081                          # Trigger arm
cr.ws 1234 00000088 000000FF                 # Check Trigger detected
#
pr.ws 1234 00000082                          # Trigger clear
pr.ws 1234 00000081                          # Trigger arm
cr.ws 1234 00000088 000000FF                 # Check Trigger detected
pr.ws 1234 000000c0                          # Enable TTIM driver  U749 SY89832
#---------------------
pr.ws 1234 000000c2                          # Trigger clear
pr.ws 1234 000000c1                          # Trigger arm
cr.ws 1234 000000c8 000000FF                 # Check Trigger detected 1st
#---------------------
pr.ws 1234 000000c2                          # Trigger clear
pr.ws 1234 000000c1                          # Trigger arm
cr.ws 1234 000000c8 000000FF                 # Check Trigger detected 2nd
# ------------------------------------------------------

$echo *****************************************************************
$echo    FASTSCOPE basic TTIM Initialisation terminated  
$echo *****************************************************************
# <EOF>
